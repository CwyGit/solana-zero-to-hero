# ğŸ“˜ ç¨‹åºå®‰å…¨ - å­¦ä¹ ç¬”è®°

> ğŸ¯ **ä¸€å¥è¯æ€»ç»“**ï¼šæŒæ¡Solanaç¨‹åºçš„10å¤§å®‰å…¨æ¼æ´åŠé˜²æŠ¤æ–¹æ³•ï¼Œè®©ä½ çš„æ™ºèƒ½åˆçº¦å›ºè‹¥é‡‘æ±¤ã€‚

---

## ğŸ“‹ å®‰å…¨æ£€æŸ¥æ¸…å•

| æ¼æ´ç±»å‹ | å±å®³ | Anchoré˜²æŠ¤ |
|----------|------|------------|
| ç­¾åè€…æœªæ£€æŸ¥ | æœªæˆæƒæ“ä½œ | `Signer<'info>` |
| æ‰€æœ‰æƒæœªæ£€æŸ¥ | ä¼ªé€ è´¦æˆ·æ”»å‡» | `Account<'info, T>` |
| ä»»æ„CPI | è°ƒç”¨æ¶æ„ç¨‹åº | `Program<'info, T>` |
| æ•°æ®ä¸åŒ¹é… | ä½¿ç”¨é”™è¯¯è´¦æˆ· | `has_one` / `constraint` |
| é‡å¤å¯å˜è´¦æˆ· | æ•°æ®è¦†ç›– | è´¦æˆ·åœ°å€æ£€æŸ¥ |
| PDAå…±äº« | æƒé™æ··æ·† | ä½¿ç”¨å”¯ä¸€ç§å­ |
| é‡æ–°åˆå§‹åŒ– | è¦†ç›–å·²æœ‰æ•°æ® | `init` + åˆ¤åˆ«å™¨ |
| å¤æ´»æ”»å‡» | åƒµå°¸è´¦æˆ· | `force_defund = true` |
| ç±»å‹ä¼ªè£… | ç±»å‹æ··æ·† | åˆ¤åˆ«å™¨éªŒè¯ |

---

## ğŸ”‘ åå¤§å®‰å…¨æ¼æ´è¯¦è§£

### 1ï¸âƒ£ ç­¾åè€…æ£€æŸ¥ (Signer Checks)

**æ¼æ´**ï¼šæœªéªŒè¯æ“ä½œè€…æ˜¯å¦ç­¾å
```rust
// âŒ å±é™©ï¼šä»»ä½•äººéƒ½èƒ½è°ƒç”¨
pub fn withdraw(ctx: Context<Withdraw>) -> Result<()> {
    // æ²¡æœ‰æ£€æŸ¥ owner æ˜¯å¦ç­¾åï¼
}

// âœ… å®‰å…¨ï¼šä½¿ç”¨Signerç±»å‹
#[derive(Accounts)]
pub struct Withdraw<'info> {
    #[account(mut)]
    pub owner: Signer<'info>,  // è‡ªåŠ¨éªŒè¯ç­¾å
}
```

---

### 2ï¸âƒ£ æ‰€æœ‰æƒæ£€æŸ¥ (Owner Checks)

**æ¼æ´**ï¼šæœªéªŒè¯è´¦æˆ·å½’å±äºæ­£ç¡®ç¨‹åº
```rust
// âŒ å±é™©ï¼šå¯èƒ½ä¼ å…¥å‡è´¦æˆ·
pub fn process(ctx: Context<Process>) -> Result<()> {
    let data = &ctx.accounts.data;  // data å¯èƒ½ä¸æ˜¯æˆ‘ä»¬ç¨‹åºåˆ›å»ºçš„ï¼
}

// âœ… å®‰å…¨ï¼šAccountç±»å‹è‡ªåŠ¨éªŒè¯æ‰€æœ‰æƒ
#[derive(Accounts)]
pub struct Process<'info> {
    pub data: Account<'info, MyData>,  // éªŒè¯owneræ˜¯å½“å‰ç¨‹åº
}
```

---

### 3ï¸âƒ£ ä»»æ„CPI (Arbitrary CPI)

**æ¼æ´**ï¼šCPIè°ƒç”¨æœªéªŒè¯çš„ç¨‹åº
```rust
// âŒ å±é™©ï¼šæ¶æ„ç¨‹åºå¯èƒ½è¢«ä¼ å…¥
invoke(&ix, &[acc1, acc2], &malicious_program)?;

// âœ… å®‰å…¨ï¼šä½¿ç”¨Programç±»å‹
#[derive(Accounts)]
pub struct SafeCpi<'info> {
    pub token_program: Program<'info, Token>,  // éªŒè¯æ˜¯æ­£ç¡®çš„ç¨‹åº
}
```

---

### 4ï¸âƒ£ æ•°æ®åŒ¹é… (Data Matching)

**æ¼æ´**ï¼šè´¦æˆ·é—´å…³ç³»æœªéªŒè¯
```rust
// âœ… å®‰å…¨ï¼šä½¿ç”¨has_oneéªŒè¯å…³è”
#[derive(Accounts)]
pub struct Transfer<'info> {
    #[account(has_one = owner)]  // éªŒè¯vault.owner == owner.key()
    pub vault: Account<'info, Vault>,
    pub owner: Signer<'info>,
}
```

---

### 5ï¸âƒ£ é‡å¤å¯å˜è´¦æˆ· (Duplicate Mutable Accounts)

**æ¼æ´**ï¼šåŒä¸€è´¦æˆ·ä½œä¸ºä¸¤ä¸ªå¯å˜å‚æ•°ä¼ å…¥
```rust
// âŒ å±é™©ï¼šfromå’Œtoæ˜¯åŒä¸€ä¸ªè´¦æˆ·æ—¶ä¼šå‡ºé—®é¢˜
pub fn transfer(from: &mut Account, to: &mut Account) { ... }

// âœ… å®‰å…¨ï¼šæ£€æŸ¥åœ°å€ä¸åŒ
#[account(
    constraint = from.key() != to.key() @ MyError::SameAccount
)]
```

---

### 6ï¸âƒ£ PDAå…±äº« (PDA Sharing)

**æ¼æ´**ï¼šå¤šç”¨æˆ·å…±äº«åŒä¸€PDA
```rust
// âŒ å±é™©ï¼šæ‰€æœ‰ç”¨æˆ·å…±ç”¨ä¸€ä¸ªvault
seeds = [b"vault"]

// âœ… å®‰å…¨ï¼šæ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹vault
seeds = [b"vault", user.key().as_ref()]
```

---

### 7ï¸âƒ£ é‡æ–°åˆå§‹åŒ–æ”»å‡» (Reinitialization)

**æ¼æ´**ï¼šå·²åˆå§‹åŒ–è´¦æˆ·å¯è¢«é‡æ–°åˆå§‹åŒ–
```rust
// âœ… Anchorçš„initä¼šè‡ªåŠ¨æ£€æŸ¥åˆ¤åˆ«å™¨
// å¦‚æœè´¦æˆ·å·²åˆå§‹åŒ–ï¼Œinitä¼šå¤±è´¥

#[account(init, payer = user, space = 8 + 32)]
pub data: Account<'info, MyData>,
```

---

### 8ï¸âƒ£ å¤æ´»æ”»å‡» (Revival Attacks)

**æ¼æ´**ï¼šå…³é—­çš„è´¦æˆ·è¢«å……å€¼å"å¤æ´»"
```rust
// âœ… å®‰å…¨ï¼šä½¿ç”¨force_defundç¡®ä¿è´¦æˆ·æ— æ³•å¤æ´»
#[account(mut, close = user)]
pub data: Account<'info, MyData>,
// Anchor v0.25.0+è‡ªåŠ¨å¤„ç†
```

---

### 9ï¸âƒ£ ç±»å‹ä¼ªè£… (Type Cosplay)

**æ¼æ´**ï¼šç”¨Aç±»å‹è´¦æˆ·å†’å……Bç±»å‹
```rust
// âœ… Anchoré€šè¿‡åˆ¤åˆ«å™¨è‡ªåŠ¨åŒºåˆ†ç±»å‹
// æ¯ä¸ªè´¦æˆ·ç±»å‹æœ‰å”¯ä¸€çš„8å­—èŠ‚åˆ¤åˆ«å™¨
#[account]
pub struct TypeA { ... }  // åˆ¤åˆ«å™¨: sha256("account:TypeA")[0..8]

#[account]
pub struct TypeB { ... }  // åˆ¤åˆ«å™¨: sha256("account:TypeB")[0..8]
```

---

## ğŸ’¡ å®‰å…¨æœ€ä½³å®è·µ

### ä½¿ç”¨Anchorå†…ç½®ä¿æŠ¤
```rust
// 1. æ€»æ˜¯ä½¿ç”¨ç±»å‹å®‰å…¨çš„è´¦æˆ·ç±»å‹
pub signer: Signer<'info>,           // ä¸æ˜¯ AccountInfo
pub token: Account<'info, TokenAccount>,  // ä¸æ˜¯ UncheckedAccount
pub program: Program<'info, Token>,   // ä¸æ˜¯ AccountInfo

// 2. å……åˆ†åˆ©ç”¨çº¦æŸ
#[account(
    mut,
    has_one = authority,
    constraint = vault.amount >= amount @ MyError::InsufficientFunds
)]
```

### ä»£ç å®¡è®¡æ£€æŸ¥ç‚¹
- [ ] æ‰€æœ‰æ•æ„Ÿæ“ä½œéƒ½éªŒè¯äº†ç­¾åè€…
- [ ] æ‰€æœ‰è´¦æˆ·éƒ½éªŒè¯äº†æ‰€æœ‰æƒ
- [ ] CPIè°ƒç”¨çš„ç¨‹åºéƒ½ç»è¿‡éªŒè¯
- [ ] PDAä½¿ç”¨äº†è¶³å¤Ÿå”¯ä¸€çš„ç§å­
- [ ] å…³é—­è´¦æˆ·ä½¿ç”¨äº†`close`çº¦æŸ

---

## ğŸ”— å»¶ä¼¸é˜…è¯»

- [Solanaå®‰å…¨æœ€ä½³å®è·µ](https://github.com/coral-xyz/sealevel-attacks)
- [Anchorå®‰å…¨æŒ‡å—](https://www.anchor-lang.com/docs/security)

---

**å­¦ä¹ å»ºè®®**ï¼šæ¯å†™ä¸€ä¸ªç¨‹åºï¼Œå¯¹ç…§è¿™10æ¡æ£€æŸ¥ä¸€éï¼
