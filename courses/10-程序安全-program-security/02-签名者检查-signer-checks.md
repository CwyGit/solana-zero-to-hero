# 02-ç­¾åè€…æ£€æŸ¥ - ç¬¬ä¸€é“é˜²çº¿ï¼ğŸ”

å˜¿ï¼Œå°ä¼™ä¼´ï¼ğŸ‘‹

**ç­¾åè€…æ£€æŸ¥**æ˜¯æ‰‹å†™ç­¾åçš„æ•°å­—ç­‰ä»·ç‰©ï¼Œå®ƒä»¬è¯æ˜è´¦æˆ·æŒæœ‰äººç¡®å®æˆæƒäº†äº¤æ˜“ï¼

**æ¯”å–»è¯´æ˜ï¼š** å°±åƒä½ å»é“¶è¡Œå–é’±å¿…é¡»ç­¾åä¸€æ ·ï¼ŒåŒºå—é“¾ä¸Šä¹Ÿéœ€è¦æ•°å­—ç­¾åï¼

---

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ç­¾åè€…æ£€æŸ¥ï¼Ÿ

### ç—›ç‚¹ï¼šä»»ä½•äººéƒ½èƒ½æ“ä½œä½ çš„è´¦æˆ·ï¼Ÿ

**æƒ³è±¡ä¸€ä¸‹ï¼š** å¦‚æœæ²¡æœ‰ç­¾åè€…æ£€æŸ¥ï¼Œä»»ä½•äººéƒ½å¯ä»¥è½¬ç§»ä½ çš„èµ„äº§ï¼Œå°±åƒä½ çš„é“¶è¡Œå¡æ²¡æœ‰å¯†ç ï¼

**å°ä¼™ä¼´ä»¬è¦ç‰¹åˆ«æ³¨æ„å•¦ï¼š**

> âš ï¸ ç¼ºå°‘ç­¾åè€…æ£€æŸ¥çš„åæœæ˜¯ç¾éš¾æ€§çš„ï¼š
> - æœªç»æˆæƒçš„è®¿é—®
> - è´¦æˆ·èµ„é‡‘è¢«ç›—
> - ç¨‹åºçŠ¶æ€å®Œå…¨å¤±æ§

---

## ğŸ”“ æ¼æ´ç¤ºä¾‹

### æ˜“å—æ”»å‡»çš„ä»£ç 

```rust
#[program]
pub mod insecure_update {
    pub fn update_ownership(ctx: Context<UpdateOwnership>) -> Result<()> {
        ctx.accounts.program_account.owner = ctx.accounts.new_owner.key();
        Ok(())
    }
}

#[derive(Accounts)]
pub struct UpdateOwnership<'info> {
    /// CHECK: æ³¨æ„ï¼è¿™é‡Œæ²¡æœ‰æ£€æŸ¥ç­¾å
    pub owner: UncheckedAccount<'info>,
    /// CHECK: æ–°æ‰€æœ‰è€…
    pub new_owner: UncheckedAccount<'info>,
    #[account(mut, has_one = owner)]
    pub program_account: Account<'info, ProgramAccount>,
}
```

**çœ‹èµ·æ¥å®‰å…¨å—ï¼Ÿ** ä¸ï¼æœ‰è‡´å‘½ç¼ºé™·ï¼

---

## ğŸ•µï¸ æ”»å‡»æ–¹å¼

**æ”»å‡»è€…å¯ä»¥ï¼š**
1. æ‰¾åˆ°ä»»ä½•ç¨‹åºè´¦æˆ·
2. è¯»å–å½“å‰ownerçš„å…¬é’¥
3. æ„é€ äº¤æ˜“ï¼Œå‡è£…æ˜¯owner
4. å°†è‡ªå·±è®¾ç½®ä¸ºnew_owner
5. **æ— éœ€çœŸå®ownerç­¾å**å°±èƒ½æäº¤ï¼

**ç»“æœï¼š** è´¦æˆ·è¢«åŠ«æŒï¼

**æ¯”å–»ï¼š** å°±åƒå°å·æ‹¿ç€ä½ çš„èº«ä»½è¯å¤å°ä»¶å°±èƒ½å–èµ°ä½ çš„é’±ï¼

---

## âœ… æ­£ç¡®åšæ³•

### æ–¹æ³•1ï¼šä½¿ç”¨Signerç±»å‹

```rust
#[derive(Accounts)]
pub struct UpdateOwnership<'info> {
    pub owner: Signer<'info>,  // âœ… æ­£ç¡®ï¼
    /// CHECK: æ–°æ‰€æœ‰è€…
    pub new_owner: UncheckedAccount<'info>,
    #[account(mut, has_one = owner)]
    pub program_account: Account<'info, ProgramAccount>,
}
```

---

### æ–¹æ³•2ï¼šæ·»åŠ signerçº¦æŸ

```rust
#[derive(Accounts)]
pub struct UpdateOwnership<'info> {
    #[account(signer)]  // âœ… æ·»åŠ çº¦æŸ
    /// CHECK: æ‰€æœ‰è€…
    pub owner: UncheckedAccount<'info>,
    // ...
}
```

---

### æ–¹æ³•3ï¼šæ‰‹åŠ¨æ£€æŸ¥

```rust
pub fn update_ownership(ctx: Context<UpdateOwnership>) -> Result<()> {
    // âœ… æ‰‹åŠ¨æ£€æŸ¥
    if !ctx.accounts.owner.is_signer {
        return Err(ProgramError::MissingRequiredSignature.into());
    }
    
    ctx.accounts.program_account.owner = ctx.accounts.new_owner.key();
    Ok(())
}
```

---

## ğŸ› ï¸ Pinocchioå®ç°

åœ¨Pinocchioä¸­ï¼Œå¿…é¡»åœ¨æŒ‡ä»¤é€»è¾‘ä¸­æ£€æŸ¥ï¼š

```rust
if !self.accounts.owner.is_signer() {
    return Err(ProgramError::MissingRequiredSignature.into());
}
```

**æ¯”å–»ï¼š** Pinocchioå°±åƒæ‰‹åŠ¨æŒ¡ï¼Œä½ éœ€è¦è‡ªå·±æ£€æŸ¥æ¯ä¸€æ­¥ï¼

---

## ğŸ’¡ å­¦ä¹ å»ºè®®

### è®°ä½è¿™äº›è¦ç‚¹

**å¿…é¡»æ£€æŸ¥ç­¾åçš„æƒ…å†µï¼š**
- âœ… è½¬ç§»æ‰€æœ‰æƒ
- âœ… ä¿®æ”¹æƒé™
- âœ… èµ„é‡‘è½¬ç§»
- âœ… æ•æ„Ÿæ•°æ®æ›´æ–°

**æ£€æŸ¥æ–¹æ³•ä¼˜å…ˆçº§ï¼š**
1. `Signer<'info>` - æœ€æ¨è
2. `#[account(signer)]` - ä¹Ÿå¾ˆå¥½
3. `is_signer` - æ‰‹åŠ¨æ£€æŸ¥

---

## â“ å¸¸è§é—®é¢˜

### Q1: has_oneçº¦æŸä¸å¤Ÿå—ï¼Ÿ

**ç­”ï¼š** ä¸å¤Ÿï¼

`has_one`åªæ£€æŸ¥å…¬é’¥åŒ¹é…ï¼Œ**ä¸æ£€æŸ¥ç­¾å**ï¼

**æ¯”å–»ï¼š** å°±åƒæ£€æŸ¥èº«ä»½è¯å·ç å¯¹äº†ï¼Œä½†æ²¡éªŒè¯æ˜¯ä¸æ˜¯æœ¬äººï¼

---

### Q2: ä»€ä¹ˆæ—¶å€™å¿…é¡»ç”¨Signerï¼Ÿ

**ç­”ï¼š** ä»»ä½•æ¶‰åŠæƒé™çš„æ“ä½œï¼

ç‰¹åˆ«æ˜¯ï¼š
- æ‰€æœ‰æƒè½¬ç§»
- æƒé™ä¿®æ”¹
- èµ„é‡‘æ“ä½œ

---

### Q3: UncheckedAccountå®‰å…¨å—ï¼Ÿ

**ç­”ï¼š** å¾ˆå±é™©ï¼

é™¤éä½ **å®Œå…¨çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆ**ï¼Œå¦åˆ™é¿å…ä½¿ç”¨ï¼

---

## ğŸ¯ å®æˆ˜å»ºè®®

**éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•ï¼š**
- [ ] æ‰€æœ‰ownerè´¦æˆ·éƒ½æ˜¯Signerç±»å‹
- [ ] æ‰€æœ‰authorityè´¦æˆ·éƒ½æœ‰ç­¾åæ£€æŸ¥
- [ ] æ•æ„Ÿæ“ä½œéƒ½éªŒè¯äº†ç­¾å
- [ ] æ²¡æœ‰ä½¿ç”¨UncheckedAccountï¼ˆé™¤éå¿…è¦ï¼‰

---

**ç°åœ¨å°ä¼™ä¼´ä»¬æ‡‚äº†å§ï¼Ÿ** ç­¾åè€…æ£€æŸ¥æ˜¯å®‰å…¨çš„ç¬¬ä¸€é“é˜²çº¿ï¼ğŸ”

**æ¯”å–»æ€»ç»“ï¼š** å°±åƒé—¨é”ï¼Œè™½ç„¶ç®€å•ä½†å¿…ä¸å¯å°‘ï¼

---

**æœ€åæ›´æ–°**ï¼š2026å¹´1æœˆ9æ—¥  
**åˆ¶ä½œé£æ ¼**ï¼šè«å¼é£æ ¼  
**å­¦ä¹ å»ºè®®**ï¼šè¿™æ˜¯å®‰å…¨åŸºç¡€ï¼ŒåŠ¡å¿…ç‰¢è®°ï¼