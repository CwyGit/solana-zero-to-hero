# 06-测试你的程序 - 确保代码安全！🧪

嘿，小伙伴！👋

在主网部署之前，进行彻底的测试是**至关重要**的，以识别潜在的漏洞和问题！

---

## 🎯 为什么要测试？

**测试的重要性：**

✅ **防止财务损失** - 避免代币被盗  
✅ **建立用户信任** - 用户更放心使用  
✅ **确保正常运行** - 各种条件下都能工作  

**比喻说明：** 就像飞机起飞前的安全检查，绝不能省！

**小伙伴们要特别注意啦：**

> ⚠️ 未经测试的程序就像没有刹车的车，非常危险！

---

## 🔬 Mollusk测试框架

### 什么是Mollusk？

**定义：** Mollusk是一个专为Solana程序设计的Rust测试框架！

**作用：** 让你能够：
- 在没有网络开销的情况下独立测试程序逻辑
- 轻松设置复杂的账户状态和程序条件
- 比完整的集成测试运行速度更快
- 模拟特定的区块链条件和边界情况

**比喻：** 就像汽车的模拟驾驶舱，可以在安全环境中测试各种情况！

---

### 为什么选择Mollusk？

**优势：**

✅ **快速** - 无需启动完整validator    
✅ **灵活** - 完全控制测试环境  
✅ **精确** - 可以测试边界情况  

**比喻：** 就像在实验室里做实验，比在现场测试安全多了！

---

## 🔗 深入学习Mollusk

我们在[这里](/zh-CN/courses/testing-with-mollusk)详细介绍了Mollusk测试！

**课程内容包括：**
- Mollusk的基础用法
- 如何设置测试环境
- 账户和指令的构建
- 验证系统的使用

---

## 💻 在Pinocchio中使用Mollusk

### 步骤1：导入测试模块

在你的`lib.rs`文件中使用`test`配置标志导入测试模块：

```rust
#[cfg(test)]
pub mod tests;
```

**解释：** `#[cfg(test)]`表示只在测试时编译这个模块！

---

### 步骤2：编写测试

在`tests.rs`文件中编写你的测试：

```rust
use mollusk_svm::Mollusk;
use solana_sdk::pubkey::Pubkey;

#[test]
fn test_my_instruction() {
    let program_id = Pubkey::new_unique();
    let mollusk = Mollusk::new(&program_id, "target/deploy/program");
    
    // 设置账户和指令
    // ...
    
    // 执行测试
    mollusk.process_instruction(&instruction, &accounts);
}
```

---

## 🚀 运行测试

使用以下命令运行你的测试：

```bash
cargo test-sbf
```

**这个命令会：**
1. 编译你的程序为SBF格式
2. 运行所有测试
3. 显示测试结果

**比喻：** 就像给汽车做全面检测！

---

## 💡 测试建议

### 应该测试什么？

**关键测试点：**

#### 1. 正常流程

✅ 测试指令是否按预期工作

---

#### 2. 边界情况

✅ 余额为0时的转账  
✅ 最大值溢出  
✅ 空数据处理  

---

#### 3. 错误处理

✅ 缺少签名会失败吗？  
✅ 错误的账户owner会失败吗？  
✅ 无效数据会被拒绝吗？  

---

#### 4. 安全检查

✅ PDA验证是否正确？  
✅ owner检查是否完整？  
✅ 权限验证是否严格？  

---

## ❓ 常见问题

### Q1: 为什么不在devnet测试？

**答：** Devnet测试有用，但是：
- 速度慢（需要等待交易确认）
- 成本高（需要获取devnet SOL）
- 难以重现（环境不稳定）

**Mollusk的优势：**
- 速度快（毫秒级）
- 零成本（本地运行）
- 可重现（完全控制环境）

---

### Q2: Mollusk和Anchor测试有什么区别？

**答：** 
- **Anchor测试**：使用Anchor的测试框架
- **Mollusk测试**：直接在SVM上测试

**Pinocchio + Mollusk**：最佳组合！

---

### Q3: 测试覆盖率要达到多少？

**建议：**
- 核心逻辑：100%
- 错误处理：100%
- 边界情况：尽可能多

**比喻：** 就像飞机的安全检查，越全面越好！

---

## 🎯 下一步

**学完这一章，你应该：**

- ✓ 理解测试的重要性
- ✓ 知道Mollusk的优势
- ✓ 能够运行基本测试

**准备好了吗？** 下一章我们将学习**Performance性能优化**！

---

**现在小伙伴们懂了吧？** 测试是保证程序安全的最后一道防线！🧪

---

**最后更新**：2026年1月9日  
**制作风格**：莫式风格  
**学习建议**：养成先写测试的习惯，TDD(测试驱动开发)是个好方法！