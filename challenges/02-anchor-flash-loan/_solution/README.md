# ğŸ¯ Anchoré—ªç”µè´·æŒ‘æˆ˜ - å‚è€ƒç­”æ¡ˆ

å˜¿ï¼Œå°ä¼™ä¼´ï¼ğŸ‘‹

è¿™æ˜¯ **Anchor Flash Loanï¼ˆé—ªç”µè´·ï¼‰** æŒ‘æˆ˜çš„å®Œæ•´å‚è€ƒç­”æ¡ˆï¼

**æ¯”å–»è¯´æ˜**ï¼šé—ªç”µè´·å°±åƒ"å€Ÿé’±â†’ä½¿ç”¨â†’è¿˜é’±"å¿…é¡»åœ¨åŒä¸€ç¬”äº¤æ˜“å†…å®Œæˆï¼Œå¦åˆ™äº¤æ˜“å¤±è´¥ï¼

---

## ğŸ“‹ é¢˜ç›®å›é¡¾

**ç›®æ ‡**ï¼šå®ç°æ— æŠµæŠ¼é—ªç”µè´·åŠŸèƒ½

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. **å€Ÿæ¬¾**ï¼šç”¨æˆ·å€Ÿå‡ºèµ„é‡‘
2. **è¿˜æ¬¾æ£€æŸ¥**ï¼šç¡®ä¿åŒä¸€äº¤æ˜“å†…è¿˜æ¬¾

---

## ğŸ§  è§£é¢˜æ€è·¯

### é—ªç”µè´·åŸç†

```
äº¤æ˜“å¼€å§‹
  â†“ borrowï¼ˆå€Ÿå‡ºèµ„é‡‘ï¼‰
ç”¨æˆ·æ‰§è¡Œä»»æ„æ“ä½œ
  â†“ repayï¼ˆè¿˜æ¬¾ + æ‰‹ç»­è´¹ï¼‰
äº¤æ˜“éªŒè¯ï¼šå€Ÿå‡ºé‡‘é¢ + è´¹ç”¨ = è¿˜æ¬¾é‡‘é¢
  â†“
äº¤æ˜“ç»“æŸ âœ… æˆ– å›æ»š âŒ
```

**å…³é”®**ï¼šä½¿ç”¨**æŒ‡ä»¤å†…çœ**éªŒè¯åŒä¸€äº¤æ˜“åŒ…å«è¿˜æ¬¾æŒ‡ä»¤ï¼

---

## ğŸ’» æ ¸å¿ƒä»£ç 

### å€Ÿæ¬¾æŒ‡ä»¤

```rust
pub fn borrow(ctx: Context<Borrow>, amount: u64) -> Result<()> {
    // 1. éªŒè¯è¿˜æ¬¾æŒ‡ä»¤å­˜åœ¨ï¼ˆæŒ‡ä»¤å†…çœï¼‰
    let ixs = ctx.accounts.instructions.to_account_info();
    let current_ix_index = load_current_index_checked(&ixs)?;
    
    // æ£€æŸ¥åç»­æŒ‡ä»¤åŒ…å«repay
    let mut found_repay = false;
    for i in (current_ix_index + 1).. {
        if let Ok(ix) = load_instruction_at_checked(i as usize, &ixs) {
            if ix.program_id == crate::ID {
                // æ£€æŸ¥æ˜¯å¦æ˜¯repayæŒ‡ä»¤
                found_repay = true;
                break;
            }
        } else {
            break;
        }
    }
    require!(found_repay, FlashLoanError::NoRepayInstruction);
    
    // 2. è½¬å‡ºèµ„é‡‘ç»™å€Ÿæ¬¾äºº
    transfer_tokens(pool, borrower, amount)?;
    
    Ok(())
}
```

### è¿˜æ¬¾æŒ‡ä»¤

```rust
pub fn repay(ctx: Context<Repay>, amount: u64, fee: u64) -> Result<()> {
    // éªŒè¯è¿˜æ¬¾é‡‘é¢
    let required = amount + fee;
    
    // è½¬å›èµ„é‡‘
    transfer_tokens(borrower, pool, required)?;
    
    Ok(())
}
```

---

## ğŸ”‘ å…³é”®ç‚¹

| çŸ¥è¯†ç‚¹ | è¯´æ˜ |
|--------|------|
| æŒ‡ä»¤å†…çœ | `sysvar::instructions` æ£€æŸ¥äº¤æ˜“å†…å®¹ |
| åŸå­æ€§ | ä»»ä¸€æŒ‡ä»¤å¤±è´¥ï¼Œæ•´ä¸ªäº¤æ˜“å›æ»š |
| æ‰‹ç»­è´¹ | æ¿€åŠ±æµåŠ¨æ€§æä¾›è€… |

---

## âš ï¸ å¸¸è§é”™è¯¯

1. **æœªéªŒè¯è¿˜æ¬¾æŒ‡ä»¤** â†’ èµ„é‡‘è¢«ç›—
2. **æ‰‹ç»­è´¹è®¡ç®—é”™è¯¯** â†’ ç¡®ä¿ç²¾åº¦
3. **é‡å…¥æ”»å‡»** â†’ ä½¿ç”¨çŠ¶æ€é”

---

## âœ… è‡ªæµ‹æ¸…å•

- [ ] å€Ÿæ¬¾+è¿˜æ¬¾åœ¨åŒä¸€äº¤æ˜“æˆåŠŸ
- [ ] åªå€Ÿæ¬¾ä¸è¿˜æ¬¾äº¤æ˜“å¤±è´¥
- [ ] æ‰‹ç»­è´¹æ­£ç¡®è®¡ç®—

---

**åˆ¶ä½œäºº**ï¼šbruceCao  
**æœ€åæ›´æ–°**ï¼š2026å¹´1æœˆ21æ—¥  
**éš¾åº¦**ï¼šâ­â­â­â­ï¼ˆè¿›é˜¶ï¼‰
